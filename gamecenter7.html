<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; overflow: hidden; margin: 0; padding: 15px; user-select: none;}
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        #screen-display { background: rgba(0,0,0,0.3); border: 1px solid #333; height: 150px; overflow-y: auto; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #444; color: #888; cursor: wait; }
        .log-p { color: #4ecdc4; }
        .log-ai { color: #ff9f43; }
        .log-err { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="header">
        <span>ğŸ² äº’åŠ¨æ¡Œæ¸¸</span>
        <span id="player-name" style="font-size:12px; color:#aaa;">ç©å®¶</span>
    </div>
    <div id="screen-display"></div>
    <button id="dice-btn">ğŸ² æ·éª°å­</button>

    <script>
        // ----------------------------------------------------
        // é€»è¾‘åˆå§‹åŒ–
        // ----------------------------------------------------
        let gameHistory = ""; // å¯¹åº”å‚è€ƒä»£ç é‡Œçš„ DataManager æ•°æ®
        let myName = "ç©å®¶";

        // æ¸²æŸ“å‡½æ•°
        function render() {
            $('#screen-display').html(gameHistory.replace(/\n/g, "<br>")).scrollTop(9999);
        }

        // ç»Ÿä¸€ä¿å­˜å‡½æ•° (è°ƒç”¨æ­£åˆ™è„šæœ¬æä¾›çš„ API)
        async function save() {
            if (window.ST_Game_API) {
                await window.ST_Game_API.save(gameHistory);
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(name, text, css) {
            const entry = `<span class="${css}">[${name}]</span> ${text}`;
            gameHistory = gameHistory ? gameHistory + "\n" + entry : entry;
            render();
        }

        $(document).ready(function() {
            // 1. è¯»å–ç¯å¢ƒ
            if (typeof ST_UserName !== 'undefined') myName = ST_UserName;
            $('#player-name').text(myName);

            // 2. æ¢å¤æ•°æ®
            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "") {
                gameHistory = ST_InitialData;
                render();
            } else {
                addLog("ç³»ç»Ÿ", "æ¸¸æˆå‡†å¤‡å°±ç»ª", "color:#888");
                save();
            }

            // 3. ç‚¹å‡»äº‹ä»¶ (å‚è€ƒä»£ç çš„ sendSuperPrompt æµç¨‹)
            $('#dice-btn').click(async function() {
                const $btn = $(this);
                $btn.prop('disabled', true).text("å¯¹æ–¹æ€è€ƒä¸­...");

                // --- æ­¥éª¤ A: ç”¨æˆ·è¡ŒåŠ¨ ---
                const point = Math.floor(Math.random() * 6) + 1;
                addLog(myName, `æ·å‡ºäº† ${point} ç‚¹`, "log-p");
                
                // ç«‹å³ä¿å­˜ä¸€æ¬¡ (è®©æ¥¼å±‚åˆ·æ–°ï¼Œä¿ç•™ç”¨æˆ·æ“ä½œ)
                await save();

                // --- æ­¥éª¤ B: è°ƒç”¨ AI (é™é»˜) ---
                if (window.ST_Game_API) {
                    // æ„é€  Prompt
                    const prompt = `[æ·éª°å­æ¸¸æˆ] ç©å®¶(${myName})æ·å‡ºäº† ${point} ç‚¹ã€‚è¯·ä½ ä»¥{{char}}çš„èº«ä»½ä¹Ÿæ·ä¸€ä¸ªéª°å­ï¼Œå¹¶ç®€çŸ­è¯„ä»·ã€‚è¯·ç›´æ¥è¾“å‡ºç»“æœæ–‡æœ¬ï¼Œä¸è¦å¸¦ä»»ä½•æ ¼å¼ã€‚`;
                    
                    // è°ƒç”¨ generate
                    window.ST_Game_API.generate(prompt, async function(response) {
                        // --- æ­¥éª¤ C: å¤„ç†å›è°ƒ ---
                        if (response && response !== "error") {
                            // AI æˆåŠŸè¿”å›äº†æ–‡æœ¬
                            const aiName = (typeof ST_CharName !== 'undefined') ? ST_CharName : "å¯¹æ–¹";
                            addLog(aiName, response.trim(), "log-ai");
                            
                            // å†æ¬¡ä¿å­˜ (æŠŠ AI ç»“æœå†™å…¥æ¥¼å±‚)
                            await save();
                        } else {
                            // å¤„ç† 504 æˆ–å…¶ä»–é”™è¯¯
                            addLog("ç³»ç»Ÿ", "è¿æ¥è¶…æ—¶ï¼Œå¯¹æ–¹æ‰çº¿äº†", "log-err");
                            await save();
                        }
                        
                        // æ¢å¤æŒ‰é’®
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    });
                } else {
                    $btn.prop('disabled', false).text("ğŸ² æ·éª°å­ (APIæœªè¿æ¥)");
                }
            });
        });
    </script>
</body>
</html>
