<!-- Yellows Game Core v3.0 -->
<!-- è¿™æ˜¯ä¸€ä¸ªçº¯å‡€çš„ç»„ä»¶ï¼Œä¸å¸¦ DOCTYPEï¼Œä¸“é—¨ç»™æ­£åˆ™åŠ è½½ç”¨ -->

<style>
    /* --- å®¹å™¨ï¼šä»¿æ‰‹æœºæ‚¬æµ®çª— --- */
    #yellows-root {
        position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
        width: 95%; max-width: 420px; height: 700px; max-height: 80vh;
        background: #1a1a1d; border: 1px solid #4e4e50; border-radius: 20px;
        z-index: 2147483647; display: flex; flex-direction: column;
        box-shadow: 0 20px 80px rgba(0,0,0,0.9); overflow: hidden;
        font-family: "Segoe UI", sans-serif; user-select: none; color: white;
        animation: pop-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }
    @keyframes pop-in { from{opacity:0;transform:translateX(-50%) scale(0.9)} to{opacity:1;transform:translateX(-50%) scale(1)} }

    /* é¡¶éƒ¨ */
    .y-header {
        height: 45px; background: #2d2d2d; border-bottom: 1px solid #444;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 15px; cursor: move;
    }
    .y-title { color: #ffd700; font-weight: bold; letter-spacing: 1px; }
    .y-close { cursor: pointer; color: #ff5f56; font-size: 18px; font-weight: bold; }

    /* æ¡Œé¢åŒºåŸŸ */
    #y-desktop {
        flex: 1; padding: 25px; display: grid; 
        grid-template-columns: repeat(4, 1fr); grid-auto-rows: 90px; gap: 15px;
        align-content: start; background: linear-gradient(180deg, #2c3e50, #000);
    }
    .app-icon { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.1s; }
    .app-icon:active { transform: scale(0.9); }
    .app-img {
        width: 55px; height: 55px; border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px; background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .ico-uno { background: linear-gradient(135deg, #e15554, #f5d020); }
    
    /* UNO æ¸¸æˆå®¹å™¨ */
    #y-app-uno { flex: 1; display: none; flex-direction: column; background: #222; position: relative; }
    
    /* UNO æ¡Œé¢ */
    .uno-table {
        flex: 1; background: radial-gradient(circle, #27ae60, #145a32);
        padding: 15px; display: flex; flex-direction: column; justify-content: space-between;
    }

    /* å¤´åƒä¿®å¤ï¼šå¼ºåˆ¶åœ†å½¢ï¼Œé˜²æ­¢æŒ¤å‹ */
    .av-box {
        width: 55px; height: 55px; flex-shrink: 0; /* å…³é”®ï¼šç¦æ­¢è¢«å‹ç¼© */
        border-radius: 50%; border: 2px solid white; overflow: hidden;
        background: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .av-img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .zone { display: flex; align-items: flex-start; gap: 12px; }
    .z-ai { }
    .z-user { justify-content: flex-end; align-items: flex-end; margin-top: auto; }

    .bub {
        background: white; color: #000; padding: 8px 12px; border-radius: 15px;
        font-size: 13px; max-width: 160px; opacity: 0; transition: 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: relative; top: 10px;
    }
    .bub.show { opacity: 1; top: 0; }
    .bub-ai { border-top-left-radius: 0; }
    .bub-user { border-bottom-right-radius: 0; background: #d4edda; }

    .center-pile { display: flex; justify-content: center; gap: 20px; align-items: center; margin: 20px 0; }
    .card {
        width: 50px; height: 75px; background: white; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
        font-weight: 900; font-size: 20px; border: 1px solid #ccc;
        box-shadow: 2px 2px 6px rgba(0,0,0,0.4); cursor: pointer; position: relative;
    }
    .c-red { background: #e74c3c; color: white; }
    .c-blue { background: #3498db; color: white; }
    .c-green { background: #2ecc71; color: white; }
    .c-yellow { background: #f1c40f; color: black; }
    .c-back { background: #34495e; border: 2px solid white; color: transparent; }

    .my-hand { 
        display: flex; gap: 5px; overflow-x: auto; padding: 8px; 
        background: rgba(0,0,0,0.3); border-radius: 10px; min-height: 95px; align-items: center; 
    }
    .card.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
    .card.playable { border: 2px solid gold; transform: translateY(-5px); }

    /* é®ç½©å±‚ */
    #ai-mask {
        position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 99;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    .spinner { width: 30px; height: 30px; border: 3px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div id="yellows-root">
    <div class="y-header" id="y-drag">
        <span class="y-title">Game OS</span>
        <div class="y-close" onclick="$('#yellows-root').remove()">âœ•</div>
    </div>

    <!-- æ¡Œé¢ -->
    <div id="y-desktop">
        <div class="app-icon" onclick="YellowsCore.openApp('uno')">
            <div class="app-img ico-uno">ğŸƒ</div>
            <span style="font-size:12px; margin-top:5px; color:#ddd">UNO</span>
        </div>
    </div>

    <!-- UNO åº”ç”¨ -->
    <div id="y-app-uno">
        <div style="padding:10px; background:#333; display:flex; align-items:center;">
            <button onclick="YellowsCore.goHome()" style="padding:5px 10px; border:none; border-radius:5px; cursor:pointer;">â¬… è¿”å›</button>
            <span style="margin-left:20px; color:gold; font-weight:bold;">UNO å¯¹æˆ˜</span>
        </div>
        
        <div class="uno-table">
            <div id="ai-mask"><div class="spinner"></div><div>AI æ€è€ƒä¸­...</div></div>

            <!-- AIåŒº -->
            <div class="zone z-ai">
                <div class="av-box"><img id="ai-av-img" class="av-img" src=""></div>
                <div class="bub bub-ai" id="ai-bub">æ¥ä¸€æŠŠï¼Ÿ</div>
            </div>
            <div style="text-align:right; font-size:12px; color:#ccc; margin-top:-10px;">
                AI: <span id="ai-count" style="color:gold; font-weight:bold">7</span>
            </div>

            <!-- ä¸­é—´åŒº -->
            <div class="center-pile">
                <div class="card c-red" id="table-card">Start</div>
                <div class="card c-back" id="draw-btn">UNO</div>
            </div>

            <!-- ç©å®¶åŒº -->
            <div class="zone z-user">
                <div class="bub bub-user" id="user-bub">...</div>
                <div class="av-box"><img id="user-av-img" class="av-img" src=""></div>
            </div>
            <div class="my-hand" id="p-hand"></div>
        </div>
    </div>
</div>

<script>
(function() {
    // æ¥æ”¶ä» Loader ä¼ æ¥çš„æ•°æ®
    const UserData = window.YellowsUserData || { name: 'User', avatar: '', charName: 'Char', charAvatar: '' };
    const $ = window.jQuery;
    const ST = window.SillyTavern;

    // --- æ ¸å¿ƒç³»ç»Ÿ ---
    window.YellowsCore = {
        openApp: (id) => {
            $('#y-desktop').hide();
            $(`#y-app-${id}`).css('display', 'flex');
            if(id==='uno') UnoGame.init();
        },
        goHome: () => {
            $('#y-app-uno').hide();
            $('#y-desktop').fadeIn();
        }
    };

    // --- UNO å¼•æ“ ---
    const UnoGame = {
        deck: [], pHand: [], aHand: [], top: null, turn: 'player',
        colors: ['red','blue','green','yellow'],
        
        init: function() {
            // è®¾ç½®å¤´åƒ
            $('#ai-av-img').attr('src', UserData.charAvatar);
            $('#user-av-img').attr('src', UserData.userAvatar);
            
            if(this.load()) {
                console.log("è¯»æ¡£æˆåŠŸ");
            } else {
                this.restart();
            }
            this.render();
        },

        restart: function() {
            this.deck = [];
            this.colors.forEach(c => {
                for(let i=0;i<=9;i++) this.deck.push({col:c, val:i, type:'num'});
                ['skip','draw2'].forEach(t => { this.deck.push({col:c,val:t,type:t}); this.deck.push({col:c,val:t,type:t}); });
            });
            this.deck.sort(()=>Math.random()-0.5);
            this.pHand = this.draw(7);
            this.aHand = this.draw(7);
            this.top = this.draw(1)[0];
            while(isNaN(this.top.val)) { this.deck.push(this.top); this.top = this.draw(1)[0]; }
            this.turn = 'player';
            this.save();
        },

        draw: function(n) {
            let r=[]; for(let i=0;i<n;i++) { if(!this.deck.length) this.restart(); r.push(this.deck.pop()); }
            return r;
        },

        canPlay: function(c) { return c.col === this.top.col || c.val == this.top.val; },

        save: function() {
            localStorage.setItem("yellows_uno_save", JSON.stringify({
                p: this.pHand, a: this.aHand, t: this.top, turn: this.turn, d: this.deck
            }));
        },
        load: function() {
            try {
                const d = JSON.parse(localStorage.getItem("yellows_uno_save"));
                if(d && d.p) { this.pHand=d.p; this.aHand=d.a; this.top=d.t; this.turn=d.turn; this.deck=d.d; return true; }
            } catch(e){} return false;
        },

        // UI æ¸²æŸ“
        render: function() {
            const t = this.top;
            let tv = t.val; if(tv=='skip')tv='ğŸš«'; if(tv=='draw2')tv='+2';
            $('#table-card').removeClass().addClass(`card c-${t.col}`).text(tv);
            $('#ai-count').text(this.aHand.length);
            
            const h = $('#p-hand').empty();
            this.pHand.forEach((c, i) => {
                let v = c.val; if(v=='skip')v='ğŸš«'; if(v=='draw2')v='+2';
                const el = $(`<div class="card c-${c.col}">${v}</div>`);
                
                if(this.turn === 'player' && this.canPlay(c)) {
                    el.addClass('playable').click(() => this.playCard(i));
                } else {
                    el.addClass('disabled');
                }
                h.append(el);
            });
            this.save();
        },

        say: function(who, txt) {
            const el = $(who==='ai'?'#ai-bub':'#user-bub');
            el.text(txt).addClass('show');
            setTimeout(()=>el.removeClass('show'), 4000);
        },

        // ç©å®¶æ“ä½œ
        playCard: async function(idx) {
            if(this.turn !== 'player') return;
            const c = this.pHand[idx];
            this.pHand.splice(idx, 1);
            this.top = c;
            
            if(c.type === 'draw2') { this.aHand.push(...this.draw(2)); this.say('ai', '(è¢«+2)'); }
            if(c.type === 'skip') { this.render(); return; }

            this.turn = 'ai';
            this.render();
            await this.aiTurn();
        },

        // æ‘¸ç‰Œé€»è¾‘
        drawCard: async function() {
            if(this.turn !== 'player') return;
            const c = this.draw(1)[0];
            this.pHand.push(c);
            this.say('user', `æ‘¸ç‰Œ`);
            
            if(this.canPlay(c)) {
                if(window.toastr) toastr.info("æ‘¸åˆ°çš„ç‰Œå¯ä»¥å‡ºï¼");
                this.render();
            } else {
                this.render();
                await new Promise(r=>setTimeout(r, 800));
                this.turn = 'ai';
                this.render();
                await this.aiTurn();
            }
        },

        // AI é€»è¾‘ (æ¥ LLM)
        aiTurn: async function() {
            $('#ai-mask').css('display','flex');
            const valid = this.aHand.filter(c => this.canPlay(c));
            
            // LLM 
            let speech = "å‡ºç‰Œ";
            try {
                const prompt = `[UNO] Roleplay ${UserData.charName}. Move: ${valid.length>0?"Play":"Draw"}. JSON: {"speech":"..."}`;
                if(ST && ST.generateQuietPrompt) {
                    const res = await ST.generateQuietPrompt(prompt, true, false);
                    const j = res.match(/\{[\s\S]*\}/);
                    if(j) speech = JSON.parse(j[0]).speech;
                }
            } catch(e) {}

            $('#ai-mask').hide();
            this.say('ai', speech);

            if(valid.length > 0) {
                const m = valid[Math.floor(Math.random()*valid.length)];
                const idx = this.aHand.indexOf(m);
                this.aHand.splice(idx, 1);
                this.top = m;
                if(m.type === 'draw2') this.pHand.push(...this.draw(2));
                if(m.type === 'skip') { this.render(); await this.aiTurn(); return; }
            } else {
                this.aHand.push(...this.draw(1));
                this.say('ai', "æ‘¸ç‰Œ...");
            }
            this.turn = 'player';
            this.render();
        }
    };

    // ç»‘å®šäº‹ä»¶
    $('#draw-btn').off('click').on('click', () => UnoGame.drawCard());
    
    // æ‹–æ‹½
    const h = document.getElementById('y-drag'), v = document.getElementById('yellows-root');
    let d=false,x,y,ix,iy;
    h.addEventListener('mousedown',e=>{d=true;x=e.clientX;y=e.clientY;ix=v.offsetLeft;iy=v.offsetTop});
    document.addEventListener('mousemove',e=>{if(d){e.preventDefault();v.style.left=(ix+e.clientX-x)+'px';v.style.top=(iy+e.clientY-y)+'px';v.style.margin=0}});
    document.addEventListener('mouseup',()=>d=false);

    // è§¦æ‘¸æ”¯æŒ (æ‰‹æœºç«¯)
    h.addEventListener('touchstart',e=>{d=true;x=e.touches[0].clientX;y=e.touches[0].clientY;ix=v.offsetLeft;iy=v.offsetTop});
    h.addEventListener('touchmove',e=>{if(d){e.preventDefault();v.style.left=(ix+e.touches[0].clientX-x)+'px';v.style.top=(iy+e.touches[0].clientY-y)+'px';v.style.margin=0}},{passive:false});
    h.addEventListener('touchend',()=>d=false);

})();
</script>
