<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        /* --- æ²‰æµ¸å¼æš—é»‘æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            user-select: none; /* é˜²æ­¢ç©æ¸¸æˆæ—¶é€‰ä¸­æ–‡æœ¬ */
        }

        .game-console {
            display: flex;
            flex-direction: column;
            height: 100vh; /* å æ»¡ iframe */
            box-sizing: border-box;
            padding: 15px;
            background: linear-gradient(180deg, #222 0%, #1a1a1a 100%);
        }

        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .header h3 { margin: 0; font-size: 16px; color: #fff; }
        .player-tag { 
            font-size: 12px; 
            background: #333; 
            padding: 2px 8px; 
            border-radius: 4px; 
            color: #4ecdc4; 
        }

        /* æ¸¸æˆè®°å½•æ˜¾ç¤ºåŒº (å±å¹•) */
        #screen-display {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 15px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
            border: 1px solid #333;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* ä¸åŒçš„æ¶ˆæ¯é¢œè‰² */
        .log-p { color: #4ecdc4; } /* ç©å®¶ */
        .log-ai { color: #ff9f43; } /* AI */
        .log-sys { color: #a55eea; } /* ç³»ç»Ÿ */

        /* æ“ä½œåŒº */
        .controls {
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #screen-display::-webkit-scrollbar { width: 4px; }
        #screen-display::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="game-console">
        <div class="header">
            <h3>ğŸ² äº’åŠ¨æ¡Œæ¸¸</h3>
            <span class="player-tag" id="player-name">ç©å®¶</span>
        </div>

        <!-- æ‰€æœ‰çš„æ¸¸æˆå†å²éƒ½åœ¨è¿™é‡Œæ˜¾ç¤º -->
        <div id="screen-display"></div>

        <div class="controls">
            <button id="dice-btn">ğŸ² æ·éª°å­</button>
            <!-- é¢„ç•™æ‰©å±•æŒ‰é’® -->
            <!-- <button id="rps-btn" style="background:#444">âœŒï¸ çŒœæ‹³(æœªå¼€å‘)</button> -->
        </div>
    </div>

    <script>
        // å…¨å±€å†å²è®°å½•å˜é‡
        let gameHistory = "";
        // ç©å®¶åå­—
        let myName = "ç©å®¶";

        $(document).ready(function() {
            // ------------------------------------------------
            // 1. åˆå§‹åŒ–
            // ------------------------------------------------
            // è·å–åå­—
            if (typeof ST_UserName !== 'undefined') myName = ST_UserName;
            $('#player-name').text(myName);

            // æ¢å¤æ•°æ® (ST_InitialData æ¥è‡ªæ­£åˆ™æ•è·)
            const $screen = $('#screen-display');
            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "") {
                gameHistory = ST_InitialData;
                renderHistory();
            } else {
                appendLog("ç³»ç»Ÿ", "æ¸¸æˆå¼€å§‹ï¼Œè¯·ç‚¹å‡»æŒ‰é’®...", "log-sys");
                saveData(); // åˆå§‹åŒ–ä¿å­˜ä¸€æ¬¡
            }

            // ------------------------------------------------
            // 2. ç©å®¶ç‚¹å‡»äº‹ä»¶
            // ------------------------------------------------
            $('#dice-btn').click(async function() {
                const $btn = $(this);
                $btn.prop('disabled', true); // æš‚æ—¶ç¦ç”¨é˜²è¿ç‚¹

                // --- æ¸¸æˆé€»è¾‘ ---
                const point = Math.floor(Math.random() * 6) + 1;
                const text = `æ·å‡ºäº† ${point} ç‚¹`;

                // --- æ›´æ–° UI ---
                appendLog(myName, text, "log-p");
                
                // --- ä¿å­˜å¹¶è§¦å‘ AI ---
                await saveData();
                triggerAI(point);

                // 1ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => $btn.prop('disabled', false), 1000);
            });
        });

        // ------------------------------------------------
        // 3. å¤„ç† AI å›å¤ (ä¾›å¤–éƒ¨æ­£åˆ™è„šæœ¬è°ƒç”¨)
        // ------------------------------------------------
        // è¿™ä¸ªå‡½æ•°ä¼šè¢«é…’é¦†æ­£åˆ™è„šæœ¬é‡Œçš„ onAIGenerated è°ƒç”¨
        window.handleAIResponse = async function(aiText) {
            console.log("æ”¶åˆ° AI å›å¤:", aiText);
            
            // æ¸…ç†ä¸€ä¸‹ AI å›å¤å¯èƒ½å¸¦æœ‰çš„å¤šä½™ç©ºæ ¼æˆ–å¼•å·
            let cleanText = aiText.trim();
            // å¦‚æœ AI å›å¤å¤ªé•¿ï¼Œå¯èƒ½éœ€è¦æˆªæ–­ï¼Œæˆ–è€…ç›´æ¥æ˜¾ç¤º
            
            // æ›´æ–° UI
            // å‡è®¾ ST_CharName å·²æ³¨å…¥ï¼Œå¦‚æœæ²¡æ³¨å…¥å°±å« "å¯¹æ–¹"
            const aiName = (typeof ST_CharName !== 'undefined') ? ST_CharName : "å¯¹æ–¹";
            appendLog(aiName, cleanText, "log-ai");
            
            // ä¿å­˜å›æ¥¼å±‚
            await saveData();
        };

        // ------------------------------------------------
        // è¾…åŠ©å‡½æ•°
        // ------------------------------------------------

        // è¿½åŠ æ—¥å¿—å¹¶æ¸²æŸ“
        function appendLog(name, text, cssClass) {
            // æ„é€ æ–°çš„æ—¥å¿—è¡Œ
            // æ ¼å¼ï¼š[åå­—] å†…å®¹
            const newEntry = `<span class="${cssClass}">[${name}]</span> ${text}`;
            
            // å¦‚æœå†å²è®°å½•ä¸ä¸ºç©ºï¼ŒåŠ ä¸ªæ¢è¡Œ
            if (gameHistory) gameHistory += "\n";
            gameHistory += newEntry;

            renderHistory();
        }

        // æ¸²æŸ“ HTML åˆ°å±å¹•å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        function renderHistory() {
            const $screen = $('#screen-display');
            // å°†æ¢è¡Œç¬¦è½¬ä¸º <br> (è™½ç„¶ CSS è®¾ç½®äº† pre-wrapï¼Œä½†ä¸ºäº†ä¿é™©å¯ä»¥ç”¨ html æ¸²æŸ“)
            // è¿™é‡Œæˆ‘ä»¬ç›´æ¥æŠŠ gameHistory è§†ä¸º HTML ç‰‡æ®µçš„é›†åˆï¼ˆå› ä¸ºé‡Œé¢å« spanï¼‰
            // æ³¨æ„ï¼šgameHistory é‡Œç°åœ¨å­˜çš„æ˜¯å¸¦æœ‰ HTML æ ‡ç­¾çš„å­—ç¬¦ä¸²
            
            // ä¸ºäº†é¿å…é‡å¤å åŠ  HTML æ ‡ç­¾å¯¼è‡´ç»“æ„æ··ä¹±ï¼Œå»ºè®® gameHistory åªå­˜çº¯æ–‡æœ¬ï¼Ÿ
            // ä¸ï¼Œä¸ºäº†é¢œè‰²å¥½çœ‹ï¼Œæˆ‘ä»¬å­˜ HTML å­—ç¬¦ä¸²æ˜¯å¯è¡Œçš„ï¼Œåªè¦ç¡®ä¿æ ¼å¼æ­£ç¡®ã€‚
            $screen.html(gameHistory.replace(/\n/g, "<br>"));
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            $screen.scrollTop($screen[0].scrollHeight);
        }

        // ä¿å­˜åˆ°å½“å‰æ¥¼å±‚
        async function saveData() {
            if (window.saveToCurrentLayer) {
                // å°†å½“å‰çš„ gameHistory (åŒ…å« HTML æ ‡ç­¾) å­˜å›å»
                // è¿™æ ·ä¸‹æ¬¡åŠ è½½æ—¶ï¼Œæ ¼å¼å’Œé¢œè‰²éƒ½èƒ½ä¿ç•™
                await window.saveToCurrentLayer(gameHistory);
            }
        }

        // è§¦å‘ AI
        function triggerAI(userPoint) {
            if (window.triggerSlash) {
                // æ„å»ºæç¤ºè¯
                // å‘Šè¯‰ AI åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¹¶å¼ºåˆ¶å®ƒç®€çŸ­å›å¤
                const prompt = `/quiet [ç³»ç»ŸæŒ‡ä»¤: è¿™æ˜¯ä¸€ä¸ªæ·éª°å­æ¸¸æˆã€‚ç”¨æˆ·(${myName})æ·å‡ºäº† ${userPoint} ç‚¹ã€‚è¯·ä½ ä»¥{{char}}çš„èº«ä»½ä¹Ÿæ·ä¸€ä¸ªéª°å­ï¼Œæˆ–è€…å¯¹ç”¨æˆ·çš„ç‚¹æ•°è¿›è¡Œç®€çŸ­çš„è¯„ä»·/å˜²è®½/èµç¾ã€‚è¯·ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦ä½¿ç”¨Markdownæˆ–æ ‡ç­¾ã€‚] | /trigger`;
                window.triggerSlash(prompt);
            }
        }
    </script>
</body>
</html>
