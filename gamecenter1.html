<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* é˜²æ­¢ iframe å‡ºç°æ»šåŠ¨æ¡ */
        }

        .game-console {
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #222;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .header {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header h3 {
            margin: 0 0 5px 0;
            color: #fff;
            font-size: 1.2em;
        }

        .player-info {
            font-size: 0.9em;
            color: #aaa;
        }

        #player-name {
            color: #4ecdc4; /* äº®é’è‰²é«˜äº®åå­— */
            font-weight: bold;
        }

        .game-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
            outline: none;
        }

        button:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }

        button:active {
            transform: scale(0.98);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            filter: none;
        }

        /* ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        #result-log {
            min-height: 40px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 1.2em;
            color: #fff;
            display: flex;
            align-items: center;
            border-left: 4px solid #4ecdc4;
        }

        /* ç»“æœå‡ºç°çš„ç®€å•åŠ¨ç”» */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .new-result {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body>

    <div class="game-console">
        <div class="header">
            <h3>åŒå±‚æ¸¸æˆä¸­å¿ƒ</h3>
            <div class="player-info">ç©å®¶: <span id="player-name">åŠ è½½ä¸­...</span></div>
        </div>
        
        <div class="game-content">
            <button id="dice-btn">
                <span>ğŸ²</span> æ·éª°å­
            </button>
            
            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="result-log">å‡†å¤‡å¼€å§‹...</div>
        </div>
    </div>

    <!-- è¿™é‡Œçš„ Script ä¸éœ€è¦å¼•å…¥ JQueryï¼Œå› ä¸ºçˆ¶çº§åŠ è½½å™¨å·²ç»å¼•å…¥äº† -->
    <script>
        $(document).ready(function() {
            // ==========================================
            // 1. ä¿®å¤ç©å®¶åå­—æ˜¾ç¤º (è§£å†³â€œæœªçŸ¥ç©å®¶â€é—®é¢˜)
            // ==========================================
            let nameToShow = "æœªçŸ¥ç©å®¶";
            
            // ä¾æ¬¡å°è¯•è·å–æ³¨å…¥çš„å˜é‡
            if (typeof ST_UserName !== 'undefined') {
                nameToShow = ST_UserName;
            } else if (window.ST_UserName) {
                nameToShow = window.ST_UserName;
            } else if (typeof userName !== 'undefined') { // å…¼å®¹æ—§ç‰ˆæ³¨å…¥
                nameToShow = userName;
            }
            
            $('#player-name').text(nameToShow);

            // ==========================================
            // 2. æ¢å¤å†å²æ•°æ® (ä¿æŒåŒå±‚çŠ¶æ€)
            // ==========================================
            // ST_InitialData æ˜¯ä»æ­£åˆ™æ•è·ç»„é‡Œä¼ è¿›æ¥çš„ ($1)
            // å¦‚æœ ST_InitialData ä¸ä¸ºç©ºï¼Œè¯´æ˜è¿™ä¸ªæ°”æ³¡æ˜¯â€œå·²æ·å‡ºç»“æœâ€çš„çŠ¶æ€
            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "") {
                $('#result-log').html(`<span class="new-result">${ST_InitialData}</span>`);
            }

            // ==========================================
            // 3. æ¸¸æˆé€»è¾‘ï¼šæ·éª°å­
            // ==========================================
            $('#dice-btn').click(async function() {
                const $btn = $(this);
                const $log = $('#result-log');

                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if ($btn.prop('disabled')) return;
                $btn.prop('disabled', true).text('æäº¤ä¸­...');

                // --- æ¸¸æˆè®¡ç®— ---
                const point = Math.floor(Math.random() * 6) + 1;
                const resultText = `æ·å‡ºäº† ${point} ç‚¹`;

                // --- ç«‹å³æ›´æ–° UI ---
                $log.html(`<span class="new-result">${resultText}</span>`);

                // ==========================================
                // 4. æ ¸å¿ƒé€šä¿¡ï¼šä¿å­˜ + è§¦å‘ AI
                // ==========================================
                if (window.saveToCurrentLayer) {
                    console.log("[GameCenter] æ­£åœ¨ä¿å­˜æ•°æ®åˆ°å½“å‰æ¥¼å±‚...");
                    
                    try {
                        // A. å†™å…¥å½“å‰æ°”æ³¡ (ä½¿ç”¨ await ç¡®ä¿å†™å…¥å®Œæˆ)
                        // è¿™ä¼šä¿®æ”¹ DOM é‡Œçš„ <GameConsole> å†…å®¹
                        await window.saveToCurrentLayer(resultText);
                        
                        console.log("[GameCenter] ä¿å­˜æˆåŠŸï¼Œå‡†å¤‡è§¦å‘ AI...");

                        // B. è§¦å‘ AI å›å¤
                        // å»¶è¿Ÿ 500ms ç¡®ä¿é…’é¦†çŠ¶æ€åŒæ­¥
                        setTimeout(() => {
                            if (window.triggerSlash) {
                                console.log("[GameCenter] å‘é€ /trigger æŒ‡ä»¤");
                                // ä»…ä»…è§¦å‘ï¼Œä¸å¸¦å‚æ•°ï¼ŒAI ä¼šè¯»å–ä¸Šä¸‹æ–‡é‡Œçš„æœ€æ–°ç»“æœ
                                window.triggerSlash('/trigger'); 
                            } else {
                                console.warn("[GameCenter] æœªæ‰¾åˆ° triggerSlashï¼Œæ— æ³•è‡ªåŠ¨å›å¤");
                            }
                        }, 500);

                    } catch (err) {
                        console.error("[GameCenter] ä¿å­˜æˆ–è§¦å‘å¤±è´¥:", err);
                        $log.text("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
                    }

                } else {
                    console.warn("[GameCenter] æœªæ£€æµ‹åˆ°é…’é¦†ç¯å¢ƒ (window.saveToCurrentLayer ç¼ºå¤±)");
                }

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    $btn.prop('disabled', false).html('<span>ğŸ²</span> æ·éª°å­');
                }, 1000);
            });
        });
    </script>
</body>
</html>
