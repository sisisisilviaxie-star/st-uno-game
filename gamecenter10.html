<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±‚æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; overflow: hidden; margin: 0; padding: 15px; user-select: none;}
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* å±å¹•æ˜¾ç¤ºåŒºåŸŸ */
        #screen-display { 
            background: rgba(0,0,0,0.3); 
            border: 1px solid #333; 
            height: 150px; 
            overflow-y: auto; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
        }

        /* æ¯ä¸€è¡Œæ—¥å¿—çš„æ ·å¼ */
        .log-entry { margin-bottom: 5px; line-height: 1.4; border-bottom: 1px dashed #333; padding-bottom: 2px;}
        .p-name { color: #4ecdc4; font-weight: bold; }
        .ai-name { color: #ff9f43; font-weight: bold; }
        .sys-info { color: #888; font-style: italic; }

        button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:disabled { background: #444; color: #aaa; cursor: wait; }
    </style>
</head>
<body>
    <div class="header">
        <span>ğŸ² äº’åŠ¨æ¡Œæ¸¸</span>
        <span id="player-name" style="font-size:12px; color:#aaa;">ç©å®¶</span>
    </div>
    
    <!-- å±å¹•åŒºåŸŸ -->
    <div id="screen-display"></div>
    
    <button id="dice-btn">ğŸ² æ·éª°å­</button>

    <script>
        let myName = "ç©å®¶";

        // ------------------------------------------------
        // 1. æ ¸å¿ƒæ“ä½œï¼šè¿½åŠ æ—¥å¿—å¹¶æ»šåŠ¨
        // ------------------------------------------------
        function addLogHtml(htmlStr) {
            const $screen = $('#screen-display');
            $screen.append(htmlStr); // ç›´æ¥æ“ä½œ DOMï¼Œç«‹åˆ»ç”Ÿæ•ˆ
            $screen.scrollTop($screen[0].scrollHeight);
        }

        // ------------------------------------------------
        // 2. æ ¸å¿ƒæ“ä½œï¼šä¿å­˜å½“å‰ HTML åˆ°æ¥¼å±‚
        // ------------------------------------------------
        function saveToFloor() {
            // è·å–å½“å‰å±å¹•é‡Œæ‰€æœ‰çš„ HTML å†…å®¹
            const fullHtml = $('#screen-display').html();
            
            // è°ƒç”¨æ­£åˆ™è„šæœ¬æä¾›çš„ API
            if (window.ST_Bridge) {
                window.ST_Bridge.save(fullHtml);
            }
        }

        $(document).ready(function() {
            // åˆå§‹åŒ–åå­—
            if (typeof ST_UserName !== 'undefined') myName = ST_UserName;
            $('#player-name').text(myName);

            // åˆå§‹åŒ–å†å²è®°å½•
            // ST_InitialData å°±æ˜¯ä¹‹å‰ä¿å­˜çš„ fullHtml
            if (typeof ST_InitialData !== 'undefined' && ST_InitialData.trim() !== "" && ST_InitialData !== "å¯åŠ¨") {
                $('#screen-display').html(ST_InitialData);
                // æ»šåŠ¨åˆ°åº•éƒ¨
                var d = document.getElementById("screen-display");
                d.scrollTop = d.scrollHeight;
            } else {
                // å¦‚æœæ˜¯ç©ºçš„æˆ–è€…æ˜¯â€œå¯åŠ¨â€ä¸¤ä¸ªå­—ï¼Œæ˜¾ç¤ºæ¬¢è¿
                addLogHtml(`<div class="log-entry sys-info">æ¸¸æˆå°±ç»ªï¼Œè¯·æ·éª°å­...</div>`);
            }

            // ç‚¹å‡»äº‹ä»¶
            $('#dice-btn').click(function() {
                const $btn = $(this);
                $btn.prop('disabled', true).text("ç­‰å¾…è£åˆ¤...");

                // --- æ­¥éª¤ A: ç©å®¶è¡ŒåŠ¨ (UI ç«‹å³æ›´æ–°ï¼) ---
                const point = Math.floor(Math.random() * 6) + 1;
                // æ„å»º HTML
                const pLog = `<div class="log-entry"><span class="p-name">[${myName}]</span> æ·å‡ºäº† ${point} ç‚¹</div>`;
                
                // 1. é©¬ä¸Šæ˜¾ç¤ºï¼(è§£å†³ä½ ä¹‹å‰çš„â€œæ²¡æœ‰æŠ•æ·æ¶ˆæ¯â€é—®é¢˜)
                addLogHtml(pLog);

                // 2. é©¬ä¸Šä¿å­˜ (é˜²æ­¢åˆ·æ–°ä¸¢æ•°æ®)
                saveToFloor();

                // --- æ­¥éª¤ B: å‘¼å« AI ---
                if (window.ST_Bridge) {
                    const prompt = `[æ·éª°å­æ¸¸æˆ] ç©å®¶(${myName})æ·å‡ºäº† ${point} ç‚¹ã€‚è¯·ä½ ä»¥{{char}}çš„èº«ä»½ä¹Ÿæ·ä¸€ä¸ªéª°å­ï¼Œå¹¶ç®€çŸ­è¯„ä»·ã€‚ä¸è¦ä½¿ç”¨Markdownã€‚`;
                    
                    window.ST_Bridge.generate(prompt, function(response) {
                        // --- æ­¥éª¤ C: AI å›è°ƒ ---
                        if (response) {
                            const aiName = (typeof ST_CharName !== 'undefined') ? ST_CharName : "å¯¹æ–¹";
                            // æ„å»º HTML
                            const aiLog = `<div class="log-entry"><span class="ai-name">[${aiName}]</span> ${response}</div>`;
                            
                            // 3. æ˜¾ç¤º AI å›å¤
                            addLogHtml(aiLog);
                            
                            // 4. ä¿å­˜æœ€ç»ˆç»“æœ
                            saveToFloor();
                        } else {
                            addLogHtml(`<div class="log-entry sys-info">å¯¹æ–¹æ‰çº¿äº† (APIé”™è¯¯)</div>`);
                        }
                        
                        // æ¢å¤æŒ‰é’®
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    });
                } else {
                    // æ²¡æœ‰ API çš„æƒ…å†µ
                    setTimeout(() => {
                        addLogHtml(`<div class="log-entry sys-info">API æœªè¿æ¥</div>`);
                        $btn.prop('disabled', false).text("ğŸ² æ·éª°å­");
                    }, 500);
                }
            });
        });
    </script>
</body>
</html>
